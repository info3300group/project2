<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .map-layer {
    fill: #fff;
    stroke: #aaa;
  }

  #slider-container {
    width: 80%;
    margin: 20px auto;
    position: relative;
  }
</style>
</style>

<body>
  <svg></svg>
  <div id="slider-container"></div>
  <label for="temp">Currently the year is: <output id="value"></output> </label><br />
  <input id="slider" type="range" min="2010" max="2017" list="markers" value="2017" />
  </div>
  <datalist id="markers">
    <option value="2010"></option>
    <option value="2011"></option>
    <option value="2012"></option>
    <option value="2013"></option>
    <option value="2014"></option>
    <option value="2015"></option>
    <option value="2016"></option>
  </datalist>
  <!-- <input id="slider-container" type="range" min="2010" max="2017" /> -->
  <!-- <div id="selected-year">Selected Year: <span id="year-value">2010</span></div> -->
  <!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script>
    // YEAR SLIDER
    const startYear = 2017
    const input = document.querySelector("#slider");
    const value = document.querySelector("#value");
    value.textContent = startYear
    // YEAR SLIDER END

    //MAP DRAWING AND MOUSE OVER FUNCTIONS
    var width = 960,
      height = 500;

    var colorMap = {
      Bronx: '#ADD8E6', // Light Blue
      Brooklyn: '#4169E1', // Royal Blue
      Manhattan: '#00BFFF', // Deep Sky Blue
      Queens: '#1E90FF', // Dodger Blue
      'Staten Island': '#6495ED', // Cornflower Blue
    };

    const projection = d3
      .geoMercator()
      .scale(45000)
      .center([-73.935242, 40.73061])
      .translate([width / 2, height / 2]);

    // var path = d3.geo.path().projection(projection);
    const pathGenerator = d3.geoPath().projection(projection);

    var svg = d3.select('svg').attr('width', width).attr('height', height);

    var g = svg.append('g');

    var mapLayer = g.append('g').classed('map-layer', true);

    d3.json('nyc.geojson')
      .then(function (mapData) {
        d3.json('average_sale_prices.json')
          .then(function (salesPriceData) {

            const features = mapData.features;

            const allPrices = Object.keys(salesPriceData)
              .map(v => Object.keys(salesPriceData[v])
                .map(k => Number(salesPriceData[v][k]))).flat()

            const priceExtent = d3.extent(allPrices)

            const colors = Object.values(colorMap)

            /*[
              "mediumaquamarine",
              "skyblue",
              "darkcyan",
              "lightsalmon",
              "orchid"
            ]*/

            const colorScale = d3.scaleQuantile().domain(allPrices).range(colors)




            input.addEventListener("input", (event) => {
              const year = event.target.value
              value.textContent = year;
              drawHeatMap(year)

            });

            mapLayer
              .selectAll('path')
              .data(features)
              .join('path')
              .attr('d', pathGenerator)
              .style('fill', function (d) {
                return colorMap[d.properties.boro_name];
              })
              .on('mouseover', function (_, d) { mouseover(d, this) })
              .on('mouseout', function (_, d) { mouseout(d, this) })


            const legendGroup = svg.append("g")
              .attr("transform", `translate(${width*4/5}, 
            ${height * 1/2})`)


            const legendText = [priceExtent[0]] + colorScale.quantiles()

            const legendValues = Array(legendText.length).fill().map((_, i, arr) =>
              priceExtent[1] - ((i / (arr.length - 1)) * (priceExtent[1] - priceExtent[0])))

            legendGroup.selectAll("circle")
              .data(legendValues)
              .join('circle')
              .attr('cy', (_, i) => i * 30)
              .attr('cx', 0)
              .attr('r', 5)
              .attr('fill', (_,i) => colorScale(legendText[i]))

            legendGroup.selectAll("text")
              .data(legendValues)
              .join('text')
              .attr('y', (_, i) => i * 30 + 5)
              .attr('x', 20)
              .attr('r', 5)
              .text((_, i) => d3.format('$,.0f')(legendText[i]))
              .style("font-family", "sans-serif")
              .style("font-weight", "bold")
              .style("fill", 'black')

            drawHeatMap(startYear)







            function drawHeatMap(currentYear) {

              let currentYearData = []

              Object.keys(colorMap).forEach(k => {
                currentYearData[k] = salesPriceData[k][currentYear]
                colorMap[k] = colorScale(currentYearData[k])
              })

              mapLayer.selectAll('path')
                .style('fill', f => colorScale(currentYearData[f.properties.boro_name]))

            }


          })
          .catch(function (error) {
            console.error('Error loading GeoJSON:', error);
          })
      });

    function mouseover(d, path) {
      // Highlight hovered borough with orange
      //console.log(d3.select(thing))
      d3.select(path).style('fill', 'rgba(255, 165, 0, 0.3)');
      boroughName
        .text(d.properties.boro_name)
        .attr('font-size', '42px')
        .style('font-family', 'Arial');
    }

    // reset borough color and text
    function mouseout(d, path) {
      d3.select(path).style('fill', function (d) {
        return colorMap[d.properties.boro_name];
      });
      boroughName.text('');
    }

    var boroughName = g.append('text').attr('x', 20).attr('y', 45);


    //MAP DRAWING END
  </script>
</body>