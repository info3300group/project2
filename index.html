<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .map-layer {
    fill: #fff;
    stroke: #aaa;
  }

  #slider-container {
    width: 80%;
    margin: 20px auto;
    position: relative;
  }
</style>
</style>

<body>
  <svg></svg>
  <div id="slider-container"></div>
  <label for="temp">Currently the year is: <output id="value"></output> </label><br />
  <input id="slider" type="range" min="2010" max="2017" list="markers" value="2017" />
  </div>
  <datalist id="markers">
    <option value="2010"></option>
    <option value="2011"></option>
    <option value="2012"></option>
    <option value="2013"></option>
    <option value="2014"></option>
    <option value="2015"></option>
    <option value="2016"></option>
  </datalist>
  <!-- <input id="slider-container" type="range" min="2010" max="2017" /> -->
  <!-- <div id="selected-year">Selected Year: <span id="year-value">2010</span></div> -->
  <!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script>
    // YEAR SLIDER
    const startYear = 2017
    const input = document.querySelector("#slider");
    const value = document.querySelector("#value");
    value.textContent = startYear
    // YEAR SLIDER END





    //MAP DRAWING AND MOUSE OVER FUNCTIONS
    var width = 960,
      height = 500;

    // colors are actually set in colorScale below
    var colorMap = {
      Bronx: '#ADD8E6', // Light Blue
      Brooklyn: '#4169E1', // Royal Blue
      Manhattan: '#00BFFF', // Deep Sky Blue
      Queens: '#1E90FF', // Dodger Blue
      'Staten Island': '#6495ED', // Cornflower Blue
    };

    const projection = d3
      .geoMercator()
      .scale(45000)
      .center([-73.935242, 40.73061])
      .translate([width / 2, height / 2]);

    // var path = d3.geo.path().projection(projection);
    const pathGenerator = d3.geoPath().projection(projection);

    var svg = d3.select('svg').attr('width', width).attr('height', height);

    var g = svg.append('g');

    var mapLayer = g.append('g').classed('map-layer', true);

    const staten_island = [-74.05073426497877,40.56639475864599]

    d3.json('nyc.geojson')
      .then(function (mapData) {
        d3.json('average_sale_prices.json')
          .then(function (salesPriceData) {

            d3.csv('Rat_Sightings.csv').then(function (data) {
              // RAT SIGHTINGS 
              let rat_sightings_2010 = {}
              let rat_sightings_2011 = {}
              let rat_sightings_2012 = {}
              let rat_sightings_2013 = {}
              let rat_sightings_2014 = {}
              let rat_sightings_2015 = {}
              let rat_sightings_2016 = {}
              let rat_sightings_2017 = {}

              data.forEach(function (data) {
                // 2010
                if (data['Created Date'].includes('2010')) {
                  if (data['Borough'] in rat_sightings_2010) {
                    rat_sightings_2010[data['Borough']] = rat_sightings_2010[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2010[data['Borough']] = 1
                    console.log("a string", data['Borough'])
                  }
                }
                // 2011
                if (data['Created Date'].includes('2011')) {
                  if (data['Borough'] in rat_sightings_2011) {
                    rat_sightings_2011[data['Borough']] = rat_sightings_2011[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2011[data['Borough']] = 1
                  }
                }
                // 2012
                if (data['Created Date'].includes('2012')) {
                  if (data['Borough'] in rat_sightings_2012) {
                    rat_sightings_2012[data['Borough']] = rat_sightings_2012[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2012[data['Borough']] = 1
                  }
                }
                // 2013
                if (data['Created Date'].includes('2013')) {
                  if (data['Borough'] in rat_sightings_2013) {
                    rat_sightings_2013[data['Borough']] = rat_sightings_2013[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2013[data['Borough']] = 1
                  }
                }
                // 2014
                if (data['Created Date'].includes('2014')) {
                  if (data['Borough'] in rat_sightings_2014) {
                    rat_sightings_2014[data['Borough']] = rat_sightings_2014[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2014[data['Borough']] = 1
                  }
                }
                // 2015
                if (data['Created Date'].includes('2015')) {
                  if (data['Borough'] in rat_sightings_2015) {
                    rat_sightings_2015[data['Borough']] = rat_sightings_2015[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2015[data['Borough']] = 1
                  }
                }
                // 2016
                if (data['Created Date'].includes('2016')) {
                  if (data['Borough'] in rat_sightings_2016) {
                    rat_sightings_2016[data['Borough']] = rat_sightings_2016[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2016[data['Borough']] = 1
                  }
                }
                // 2017
                if (data['Created Date'].includes('2017')) {
                  if (data['Borough'] in rat_sightings_2017) {
                    rat_sightings_2017[data['Borough']] = rat_sightings_2017[data['Borough']] + 1
                  }
                  else {
                    rat_sightings_2017[data['Borough']] = 1
                  }
                }

                
              });

              console.log(rat_sightings_2010)
                console.log(rat_sightings_2011)
                console.log(rat_sightings_2012)
                console.log(rat_sightings_2013)
                console.log(rat_sightings_2014)
                console.log(rat_sightings_2015)
                console.log(rat_sightings_2016)
                console.log(rat_sightings_2017)
                let curr_rat_sightings = rat_sightings_2017
                if (value.textContent == '2010') {
                  curr_rat_sightings = rat_sightings_2010
                }
                if (value.textContent == '2011') {
                  curr_rat_sightings = rat_sightings_2011
                }
                if (value.textContent == '2012') {
                  curr_rat_sightings = rat_sightings_2012
                }
                if (value.textContent == '2013') {
                  curr_rat_sightings = rat_sightings_2013
                }
                if (value.textContent == '2014') {
                  curr_rat_sightings = rat_sightings_2014
                }
                if (value.textContent == '2015') {
                  curr_rat_sightings = rat_sightings_2015
                }
                if (value.textContent == '2016') {
                  curr_rat_sightings = rat_sightings_2016
                }
                if (value.textContent == '2017') {
                  curr_rat_sightings = rat_sightings_2017
                }
            
            // END OF RATS


            const features = mapData.features;

            const allPrices = Object.keys(salesPriceData)
              .map(v => Object.keys(salesPriceData[v])
                .map(k => Number(salesPriceData[v][k]))).flat()

            const priceExtent = d3.extent(allPrices)

            const colors = Object.values(colorMap)

            const colorScale = d3.scaleQuantile(d3.schemeBlues[6].slice(1)).domain(allPrices)

            input.addEventListener("input", (event) => {
              const year = event.target.value
              value.textContent = year;
              drawHeatMap(year)
            });

            mapLayer
              .selectAll('path')
              .data(features)
              .join('path')
              .attr('d', pathGenerator)
              .style('fill', function (d) {
                return colorMap[d.properties.boro_name];
              })
              .on('mouseover', function (_, d) { mouseover(d, this) })
              .on('mouseout', function (_, d) { mouseout(d, this) })


            const legendGroup = svg.append("g")
              .attr("transform", `translate(${width * 4 / 5}, ${height * 3 / 4})`)


            const legendText = [priceExtent[0]].concat(colorScale.quantiles())


            legendGroup.selectAll("circle")
              .data(legendText)
              .join('circle')
              .attr('cy', (_, i) => -i * 30)
              .attr('cx', 0)
              .attr('r', 5)
              .attr('fill', v => colorScale(v))

            legendGroup.selectAll("text")
              .data(legendText)
              .join('text')
              .attr('y', (_, i) => -(i * 30) + 5)
              .attr('x', 20)
              .attr('r', 5)
              .text(v => d3.format('$,.0f')(v))
              .style("font-family", "sans-serif")
              .style("font-weight", "bold")
              .style("fill", 'black')

            drawHeatMap(startYear)


            function drawHeatMap(currentYear) {

              let currentYearData = []

              Object.keys(colorMap).forEach(k => {
                currentYearData[k] = salesPriceData[k][currentYear]
                colorMap[k] = colorScale(currentYearData[k])
              })

              mapLayer.selectAll('path')
                .style('fill', f => colorScale(currentYearData[f.properties.boro_name]))

            }

            console.log('staten island projection', typeof curr_rat_sightings, Object.keys(curr_rat_sightings))
            console.log(projection(staten_island))
            // staten island rat bubble ?? 
            svg
              .append('circle')
              .attr('cx', projection(staten_island)[0])
              .attr('cy', projection(staten_island)[1])
              .attr('r', curr_rat_sightings['STATEN ISLAND'] / 50)
              .style('fill', 'red')
              .style('opacity', '0.5')
              .style('stroke', 'red');

            mapLayer
              .selectAll('path')
              .data(features)
              .join('path')
              .attr('d', pathGenerator)
              .style('fill', function (d) {
                return colorMap[d.properties.boro_name];
              })
            
            });


           


          })
          .catch(function (error) {
            console.error('Error loading GeoJSON:', error);
          });
      }
      )

    function mouseover(d, path) {
      // Highlight hovered borough with orange
      //console.log(d3.select(thing))
      d3.select(path).style('fill', 'rgba(255, 165, 0, 0.3)');
      boroughName
        .text(d.properties.boro_name)
        .attr('font-size', '42px')
        .style('font-family', 'Arial');
    }

    // reset borough color and text
    function mouseout(d, path) {
      d3.select(path).style('fill', function (d) {
        return colorMap[d.properties.boro_name];
      });
      boroughName.text('');
    }

    var boroughName = g.append('text').attr('x', 20).attr('y', 45);




    //MAP DRAWING END


  </script>
</body>